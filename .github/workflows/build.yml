name: Build TrollSpeed (.tipa)

on:
  push:
    tags:
      - "v*.*.*"
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]
  workflow_dispatch:

env:
  XCODE_VERSION: '15.1'

jobs:
  build:
    runs-on: macos-13

    steps:
      - name: Setup Xcode version
        uses: maxim-lobanov/setup-xcode@v1
        with:
          xcode-version: ${{ env.XCODE_VERSION }}

      - name: Install dependencies
        run: |
          HOMEBREW_NO_AUTO_UPDATE=1 brew install ldid zip
          echo "âœ… Installed ldid and zip"

      - name: Checkout TrollSpeed project
        uses: actions/checkout@v4
        with:
          repository: shshsjsisjsj-glitch/Trollpol
          ref: main
          path: TrollSpeed
          submodules: recursive

      - name: Make build.sh executable
        run: |
          cd $GITHUB_WORKSPACE/TrollSpeed
          chmod +x build.sh

      - name: Build TrollSpeed (.tipa)
        run: |
          cd $GITHUB_WORKSPACE/TrollSpeed
          VERSION_TAG=$(git describe --tags --always || echo "v1.0.0")
          echo "ðŸš€ Building TrollSpeed version ${VERSION_TAG}"
          ./build.sh ${VERSION_TAG}
          echo "âœ… TrollSpeed build finished."

      - name: Rename .tipa artifact
        run: |
          cd $GITHUB_WORKSPACE/TrollSpeed/packages
          FILE=$(ls *.tipa | head -n 1)
          BUILDNUM=${{ github.run_number }}
          NEWNAME="TrollSpeed_${FILE%.*}_build${BUILDNUM}.tipa"
          mv "$FILE" "$NEWNAME"
          echo "RENAMED_FILE=$NEWNAME" >> $GITHUB_ENV
          echo "ðŸ“¦ Renamed artifact to $NEWNAME"

      - name: Upload TrollSpeed artifact
        uses: actions/upload-artifact@v4
        with:
          name: TrollSpeed.tipa
          path: ${{ github.workspace }}/TrollSpeed/packages/${{ env.RENAMED_FILE }}

      - name: Upload release
        uses: softprops/action-gh-release@v1
        if: startsWith(github.ref, 'refs/tags/v')
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          body: "Build time: ${{ github.run_id }}"
          generate_release_notes: true
          files: |
            ${{ github.workspace }}/TrollSpeed/packages/${{ env.RENAMED_FILE }}
