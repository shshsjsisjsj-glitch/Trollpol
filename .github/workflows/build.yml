name: Build TrollSpeed (.tipa / .deb)

on:
  push:
    tags:
      - "v*.*.*"
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]
  workflow_dispatch:

env:
  XCODE_VERSION: '15.1'

jobs:
  build:
    runs-on: macos-13

    steps:
      - name: Setup Xcode version
        uses: maxim-lobanov/setup-xcode@v1
        with:
          xcode-version: ${{ env.XCODE_VERSION }}

      - name: Install dependencies
        run: |
          HOMEBREW_NO_AUTO_UPDATE=1 brew install ldid dpkg zip
          echo "âœ… Installed ldid, dpkg, and zip"

      - name: Checkout TrollSpeed project
        uses: actions/checkout@v4
        with:
          path: TrollSpeed
          submodules: recursive

      - name: Make scripts executable
        run: |
          cd TrollSpeed
          chmod +x build.sh || true
          chmod +x gen-control.sh || true

      - name: Get version info
        id: version
        run: |
          VERSION_TAG=$(git describe --tags --always || echo "v1.0.0")
          echo "VERSION=${VERSION_TAG}" >> $GITHUB_ENV
          echo "ğŸ“¦ Version: ${VERSION_TAG}"

      - name: Run gen-control.sh (generate DEB control)
        run: |
          cd TrollSpeed
          if [ -f "gen-control.sh" ]; then
            echo "ğŸ§© Generating DEB control file..."
            ./gen-control.sh ${{ env.VERSION }}
            echo "âœ… gen-control.sh completed."
          else
            echo "âš ï¸ No gen-control.sh found, skipping DEB control."
          fi

      - name: Run build.sh (build .tipa)
        run: |
          cd TrollSpeed
          if [ -f "build.sh" ]; then
            echo "ğŸš€ Building .tipa package..."
            ./build.sh ${{ env.VERSION }}
            echo "âœ… build.sh completed."
          else
            echo "âš ï¸ No build.sh found, skipping .tipa build."
          fi

      - name: Package .deb (if control exists)
        run: |
          cd TrollSpeed
          if [ -d "layout/DEBIAN" ]; then
            mkdir -p packages
            dpkg-deb -b layout packages/TrollSpeed_${{ env.VERSION }}_arm64.deb
            echo "âœ… Debian package created."
          else
            echo "âš ï¸ No DEBIAN layout found, skipping .deb packaging."
          fi

      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: TrollSpeed_Packages
          path: |
            ${{ github.workspace }}/TrollSpeed/packages/*.tipa
            ${{ github.workspace }}/TrollSpeed/packages/*.deb

      - name: Upload release
        uses: softprops/action-gh-release@v1
        if: startsWith(github.ref, 'refs/tags/v')
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          body: "ğŸš€ TrollSpeed build completed automatically!"
          generate_release_notes: true
          files: |
            ${{ github.workspace }}/TrollSpeed/packages/*.tipa
            ${{ github.workspace }}/TrollSpeed/packages/*.deb

      - name: Show build summary
        if: always()
        run: |
          echo "ğŸ§© Checking build output..."
          cd $GITHUB_WORKSPACE/TrollSpeed/packages || exit 0

          echo "----------------------------------------"
          echo "ğŸ“¦ Build Summary"
          echo "----------------------------------------"
          if ls *.tipa >/dev/null 2>&1; then
            echo "âœ… TrollStore build (.tipa) found:"
            ls -lh *.tipa
          else
            echo "âš ï¸ No .tipa file found."
          fi

          if ls *.deb >/dev/null 2>&1; then
            echo "âœ… Jailbreak build (.deb) found:"
            ls -lh *.deb
          else
            echo "âš ï¸ No .deb package found."
          fi
          echo "----------------------------------------"
          echo "ğŸ¯ Build completed at $(date)"
